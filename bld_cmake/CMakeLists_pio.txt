project (pio 
    DESCRIPTION "Parallel I/O Library modified by CIME developers"
    HOMEPAGE_URL "https://github.com/ESMCI/cime/tree/cime5.6.33/src/externals/pio1/pio"
    LANGUAGES C Fortran)

add_library(${PROJECT_NAME} STATIC)

find_package(MPI)
if(MPI_FOUND)
    target_compile_definitions(${PROJECT_NAME} PUBLIC USEMPIIO)
else()
    target_compile_definitions(${PROJECT_NAME} PRIVATE NO_MPIMOD NO_MPI2)
endif()

find_package(PnetCDF COMPONENTS Fortran)
if(PnetCDF_Fortran_FOUND)
    target_compile_definitions(${PROJECT_NAME} PRIVATE $<$<COMPILE_LANGUAGE:Fortran>:USE_PNETCDF_MOD>)
else()
    find_package(NetCDF COMPONENTS Fortran)
    if(NetCDF_Fortran_FOUND)
        target_compile_definitions(${PROJECT_NAME} PRIVATE $<$<COMPILE_LANGUAGE:Fortran>:_NETCDF _NETCDF4>)
    else()
        target_compile_definitions(${PROJECT_NAME} PRIVATE $<$<COMPILE_LANGUAGE:Fortran>:_PNETCDF>)
    endif()
endif()

# According to comment header in pio_support.F90, _NO_MPI_RSEND 
# is work around for poor rsend performance on cray systems with
# Gemini interconnect
# target_compile_definitions(${PROJECT_NAME} PRIVATE _NO_MPI_RSEND)

target_sources(${PROJECT_NAME} 
    PUBLIC
        alloc_mod.F90
        box_rearrange.F90
        calcdecomp.F90
        calcdisplace_mod.F90
        iompi_mod.F90
        ionf_mod.F90
        nf_mod.F90 
        piodarray.F90
        pio.F90
        pio_kinds.F90
        piolib_mod.F90
        pio_mpi_utils.F90
        pio_msg_callbacks.F90
        pio_msg_getput_callbacks.F90
        pio_msg_mod.F90
        pionfatt_mod.F90
        pionfget_mod.F90
        pionfput_mod.F90
        pionfread_mod.F90
        pio_nf_utils.F90
        pionfwrite_mod.F90
        pio_spmd_utils.F90
        pio_support.F90
        pio_types.F90
        pio_utils.F90
        rearrange.F90
        topology.c
)